<!DOCTYPE html>
<html>
  <head>
    <title><%= user.name %>'s Bubbles</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  </head>
  <script src="/socket.io/socket.io.js"></script>
  <script>

  </script>
  <body>
  <!-- Button to Open the Modal -->
  <div class="container">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
          <ul class="navbar-nav">
              <li class="nav-item">
                  <button type="button" class="btn btn-success" data-toggle="modal" data-target="#newIncomeModal">
                      New Income
                    </button>
              </li>
              <li class="nav-item">
                  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#newCostModal">
                      New Pool
                    </button>
              </li>
              <li class="nav-item">
                  <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#newCostModal">
                      New Cost
                    </button>
              </li>
            </ul>
      </nav>
    </div>
  <script>
      let selectedBubble;
      let stage = 0;
  </script>
  <div id="megaBubble">
      <div>
          <div>
              <h1 id="megaLabel">Engineering Salary</h1>
          </div>
          <div>
              <h2 style="text-align: center" id="megaAmt">$120000</h2>
          </div>
      </div>
  </div>
  <canvas width="2000" height="2000"></canvas>
  <script>
    let canvas = document.querySelector("canvas")
    let cx = canvas.getContext('2d')
    cx.beginPath();
    cx.lineWidth = 3
    cx.moveTo(200, 400);
    cx.quadraticCurveTo(600, 200, 600, 650);
    cx.stroke();
    cx.closePath();
    //
    cx.beginPath();
    cx.moveTo(200, 800);
    cx.quadraticCurveTo(100, 600, 800, 1000);
    cx.stroke();
    cx.closePath();
    //
    cx.beginPath();
    cx.moveTo(900, 1000);
    cx.quadraticCurveTo(900, 1200, 1400, 1100);
    cx.stroke();
    cx.closePath();
    //
    cx.beginPath();
    cx.moveTo(900, 1000);
    cx.quadraticCurveTo(900, 1200, 1400, 500);
    cx.stroke();
    cx.closePath();
    
  </script>
  <div id="canvas">

    <%
        let i =1;
        for(let bubble in user.bubbles){
            if(i===1){
                selectedBubble=user.bubbles[bubble];
            }
            if(i<7&&i>1){
    %>
      <div class="bubble <%=user.bubbles[bubble].type%>"
           style="left:600px; top:<%=i*200%>px;
                   width:<%=user.bubbles[bubble].pct*10%>px;height:<%=user.bubbles[bubble].pct*10%>px; margin-left:<%=user.bubbles[bubble].depth*100/user.bubbles[bubble].pct%>px" id="<%=bubble%>">
          <div>
              <div>
                  <h3><%=user.bubbles[bubble].label%></h3>
              </div>
              <div>
                  <h3 style="text-align: center"><%=user.bubbles[bubble].amt%></h3>
              </div>
          </div>
      </div>

      <%
            }

              i++;
        }
    %>
  </div>
  <!-- The Modal -->
  <div class="modal" id="newIncomeModal">
    <div class="modal-dialog">
      <div class="modal-content">

        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">New Income</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <!-- Modal body -->
        <div class="modal-body">
          <label>Label</label>             <input id="incomeLabelInput"/>
          <label>Income</label>   <input type="number" id="incomeAmtInput"/>
          <label>Type of Income</label>
          <select id="incomeTypeInput">
            <option value="salaryYearly">Yearly Income</option>
            <option value="salaryMonthly">Monthly Income</option>
            <option value="salaryWeekly">Weekly Income</option>
          </select>
        </div>

        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" data-dismiss="modal" onclick="submitNewIncome()">Save</button>
        </div>

      </div>
    </div>
  </div>

    <!-- The Modal -->
    <div class="modal" id="newPoolModal">
        <div class="modal-dialog">
          <div class="modal-content">
    
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">New Pool</h4>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
    
            <!-- Modal body -->
            <div class="modal-body">
              <label>Label</label>             <input id="incomeLabelInput"/>
              <label>Pool</label>   <input type="number" id="incomeAmtInput"/>
            </div>
    
            <!-- Modal footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-success" data-dismiss="modal" onclick="submitNewPool()">Save</button>
            </div>
          </div>
        </div>
      </div>


  <div class="modal" id="newCostModal">
    <div class="modal-dialog">
      <div class="modal-content">

        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">New Cost</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <!-- Modal body -->
        <div class="modal-body">
          <label>Label</label>             <input id="costLabelInput"/>
          <label>Cost</label>   <input type="number" id="costAmtInput"/>
          <label>Frequency</label>
          <select id="costTypeInput">
            <option value="costYearly">Yearly Expense</option>
            <option value="costMonthly">Monthly Expense</option>
            <option value="costWeekly">Weekly Expense</option>
          </select>
        </div>

        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" data-dismiss="modal" onclick="submitNewCost()">Save</button>
        </div>

      </div>
    </div>
  </div>
  <script>
    var socket = io();
    socket.on("newBubbleAdded", function(newBubbleInfo){
      if(newBubbleInfo.ownerID===<%=user.key%>+0){
        $('#canvas').append(
                "    <div class=\"bubble "+newBubbleInfo.bubbleInfo.type+"\" id=\""+newBubbleInfo.key+"\">\n" +
                "      <div>\n" +
                "        <div>\n" +
                "          <h3>"+newBubbleInfo.bubbleInfo.label+"</h3>\n" +
                "        </div>\n" +
                "        <div>\n" +
                "          <h5 style=\"text-align: center\">"+newBubbleInfo.bubbleInfo.amt+"</h5>\n" +
                "        </div>\n" +
                "      </div>\n" +
                "    </div>"
        )
      }
    });
    function submitNewIncome(){
      sendEmit("newBubble", {
        ownerID: <%=user.key%>+0,
        label: $('#incomeLabelInput').val(),
        amt: $('#incomeAmtInput').val(),
        type: $('#incomeTypeInput').val(),
        depth: 1
      })
      $('#incomeLabelInput').val('');
      $('#incomeAmtInput').val('');
      $('#incomeTypeInput').val('');
    }
    function submitNewPool(){
      sendEmit("newBubble", {
        ownerID: <%=user.key%>+0,
        label: $('#incomeLabelInput').val(),
        amt: $('#incomeAmtInput').val(),
        type: $('#incomeTypeInput').val(),
        depth: 2
      })
      $('#incomeLabelInput').val('');
      $('#incomeAmtInput').val('');
      $('#incomeTypeInput').val('');
    }
    function submitNewCost(){
      sendEmit("newBubble", {
        ownerID: <%=user.key%>+0,
        label: $('#costLabelInput').val(),
        amt: $('#costAmtInput').val(),
        type: $('#costTypeInput').val(),
        depth: 3
      })
      $('#costLabelInput').val('');
      $('#costAmtInput').val('');
      $('#costTypeInput').val('');
    }
    function sendEmit(reqName, reqData){
      socket.emit(reqName, reqData);
    }
    let allBubbles = [];
    window.onload = function() {
      var anchors = document.getElementsByClassName('bubble');
      for(let i = 0; i < anchors.length; i++) {
        let anchor = anchors[i];
        allBubbles.push(anchor);
        anchor.onclick = function() {
          selectBubble(anchors[i]);
        }
      }
    }
    function selectBubble(bubble){
        selectedBubble = bubble;
        bubble.style.transform = "scale(1.5)";
        bubble.style.transform = "translateX(100px)"
        bubble.style.transform = "translateY(300px)"
        for(let singleBubble in allBubbles) {
            if(allBubbles[singleBubble]!==bubble){
                allBubbles[singleBubble].style.marginLeft = "-1000px"
            }
        }
    }
  </script>
  </body>
</html>
